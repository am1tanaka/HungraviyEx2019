# クリア
クリアの流れは以下の通り。

- ぐらびぃがClearタグのトリガーを検出したら開始
  - ぐらびぃの操作、当たり判定を無効
  - カメラ位置を調整
  - クリア演出開始
  - 自動でブラックホールを発生
  - クリアオブジェクトの縮小と移動開始
- クリアオブジェクトの縮小が完了したら開始
  - ブラックホールを消す
  - ぐらびぃの口を開く
  - クリアオブジェクトを口へ
- クリアオブジェクトが口へ到達したら開始
  - ぐらびぃの口を閉じる
  - クリア表示
  - 残り秒数を得点にする
  - ライフボーナス(x1000)
  - アイテムのパーフェクトボーナス
- クリックか、時間経過で次のステージへ

## 実装
クリアの処理は、ぐらびぃ、ブラックホール、クリアオブジェクトを連携させて処理する必要がある。また、タイムボーナスなどの進行役でもあるので、統括役であるGameManagerに流れを管理させる。

クリアの動作は一連の流れがある。アニメーションや音声を固定のタイミングで動かすならタイムライン(TimeLine)、スクリプトによる制御がしたい場合はコルーチンを使うと手軽に実現できる。今回はキャラのいる位置に応じて動きが変わるのでコルーチンで実装する。

ぐらびぃがクリアオブジェクトに触れたら、GameManager.Clear()を呼び出す。このメソッドがクリア処理のコルーチンを開始して、クリアの一連の動作を制御する。

### タイムボーナス
タイムボーナスは桁ごとに実行する。まずは一番下の桁を0になるまで1つずつ減らしながら得点にする。それを最上桁まで行う。

点数で注意なのが、時間がfloatなのに対して、得点はintなので、値の変更時の誤差である。Mathf.FloorToInt()で指定桁数で切り捨てを行うが、この時にfloatの誤差が発生することで、表示が狙ったものにならないことがある。値が足りなくならないように、値を切り捨てる前に、最小桁より一桁小さい位に1を加えるようにした。これにより、ボーナス計算時の誤差は防げた。

もう一つの問題がボーナス加点前の状態で、残り時間とボーナス計算の値が一致しなくなることがごくまれに発生する。これを防ぐために、ボーナスを加点する前に、ボーナス計算と同じ計算をしてもとめた残り時間をタイムに表示する処理を入れた。1点増える場合があるが、ゲーム中は高速で切り替わる桁のため、気付くのは難しいと思われる。仮に気付いたとしても、1点増えるので心証を悪くすることはないだろうということで、このような設計にした。

### パーフェクトボーナス
パーフェクトボーナスは、ステージに出てくるアイテムを持っている敵を全てやっつけることと、すべてのアイテムを取ることで達成できる。ステージの開始前に合計数を求める。

- アイテムのStartに、GameManagerのアイテム数の加算を呼び出す
- 敵のStartで、アイテムを持っている場合はGameManagerのアイテム数の加算を呼び出す
- GameManagerに、アイテムを取った時に呼び出すメソッドを作り、アイテム数を減らす
- クリア時、アイテム数が0ならパーフェクト
