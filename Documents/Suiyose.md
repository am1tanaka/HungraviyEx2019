# 吸い寄せられる処理の汎用化

ブラックホールに吸い込む処理はぐらびぃに組み込みましたが、同様の処理は敵やアイテムでも発動します。同じ機能を実装するのは無駄なので、これを使いまわせるようにします。

## 汎用化の手段
オブジェクト指向で検討するなら、吸い寄せ機能を親クラスに持たせて、ぐらびぃ、敵、アイテムはそれを継承するという方法があります。

Unityであれば、ゲームオブジェクトに複数のコンポーネントをアタッチできるので、MonoBehaviourを継承した吸い寄せ機能のみのスクリプトを作成して、必要なオブジェクトにアタッチすることができます。ゲームオブジェクトに多数のMonoBehaviourをアタッチする方法は、ゲームオブジェクトごとに複数のUpdate()呼び出しが発生するため遅くなりやすいという欠点はあります。今回は、数が少なく、ゲーム内容も軽いので問題ないと判断して、こちらで実装を進めます。

# スクリプトの作成
新しいスクリプトSuiyoseを作成して、Enemy00のプレハブにアタッチします。

Graviyスクリプトを見ながら、まずは吸い込みに関する変数やプログラムを移植します。Graviyの処理は、実装が完了するまで残しておきましょう。

Suiyoseは、以下の機能を持ちます。

- Graviyが移動可能な状態の時に有効になり、移動不可の時は停止
- 設定に従ってブラックホールの位置と距離に応じて、吸い込み加速を自動的に行う
- Rigidbody2Dを自分で管理(staticにしないこと！)
- Graviyからブラックホールの吸い寄せられる処理をコピーして、public bool Suck()のような名前のメソッドを作って貼り付けて、Suiyoseで動くように名前や宣言などを整理
- FixedUpdate()にGraviy.CanMoveによる動作制限を入れて、Suck()を呼び出す

以上で、Suiyoseを敵のプレハブにアタッチしますが、まだ動きません。敵のスクリプトが、毎回強制的に速度を設定しているからです。ブラックホールに吸い寄せられている時は、その処理をキャンセルする必要があります。そのためには、Suck()を敵が呼び出すようにして、吸い寄せられているかどうかを返させて、その結果に応じて動きを変える必要があります。

- FixedUpdate()からのSuck()の呼び出しも有効にしておきたいので、Suck()を実行した時のTime.frameCountを記録しておいて、同じフレームですでに実行されていた時には、前回に記録したisSuckedを返すようにする
- Graviyや敵から、Suck()を呼び出して、戻り値に応じて吸い寄せられた時に関する処理を加える

# 敵を対応させる
敵からSuckedスクリプトを利用します。

- Enemy00スクリプトを開く
- Suiyose suiyose = null;のように宣言して、Awake()でGetComponentする
- FixedUpdate()内のUpdateMove()を呼び出す前に、suiyose.Suck()を呼び出す。戻り値がtrueなら吸い寄せられているので、アニメを切り替えて、UpdateMove()は呼ばないようにする
- そのままUpdateMove()を呼び出すと、吸い寄せが終わったらすぐに歩きに戻ってしまうため、動きが不自然になる。前回の吸い寄せ状態を記録しておいて、移動速度が歩き速度より大きい間は、UpdateMove()を呼ばないようにすることで、なじんだ感じの動きにできる

以上で敵の対応は完了です。

# ぐらびぃを対応させる
敵への対応ができたら、ぐらびぃもSuiyoseを使って吸い寄せるようにします。

- SuiyoseをGraviyプレハブにアタッチ
- Graviyスクリプトから、吸い寄せに関するコードを削除
- static Suiyose suiyose = null;のように宣言して、Awake()でGetComponentする
- FixedUpdate()内のブラックホールが発生しているかどうかのif文を削除して、suiyose.Suck()に差し替え。ブラックホールに吸い寄せられているかは、Suck()の戻り値を受け取って、それを利用して判定する

# お菓子を対応させる
お菓子のプレハブにSuiyoseをアタッチ。Rigidbody2Dも忘れずに。

お菓子は、アニメやフリップ処理が不要なので、このままで動作します。Massを小さくするか、加速を強くして、他のキャラよりも吸い寄せられやすくするとよいでしょう。

# 上昇の補正
左右に比べて、重力の効きがあるため上昇しづらい。そこで、ブラックホールとの距離に応じて重力を無効化する処理を加える。アタッチされているRigidbody2DのGravityScaleを、元の値から、当たり判定の以内に入ったら、既定の割合まで減らすようにする。

- 元のGravityScaleを記録しておく
- コライダーのbounds.extents.yを取得
- ブラックホールのYと自分の当たり判定の中心のYの距離を算出
- (距離-extents.y) / (ブラックホールの到達距離-extents.y)を求める
- GravityScaleのデフォルト値に重力の軽減率を掛けた値と、デフォルト値の間でLerpを求める
- 求めた値をGravityScaleに設定
- 重力圏外ならGravityScaleのデフォルト値を設定
