# ぐらびぃの制御

ブラックホールの制御ができたら、それをもとにぐらびぃの移動を実装できます。ブラックホールの時と同様に、まずは状態の洗い出しから行います。

# ぐらびぃの状態

## 状況を検討
まずは、ゲーム開始からぐらびぃがどのような状況になるかをリストアップします。

- ゲームが開始するまでは移動しない
- ゲームが開始したら、重力落下しつつ、慣性で移動
- ブラックホールが発生したら引き寄せられる
- 敵や障害物にぶつかるとミス
  - 弾き飛ばされて、一定時間無敵
- ライフがなくなるとゲームオーバー
- ゴールに辿り着くとクリア
- ESCキーでポーズ
- お菓子に触れたら食べる

## 状態を決める
以上を元に、入出力が変わるかどうかに着目して、状態を決めていきます。

- 移動なし
  - 開始まで
  - ゲームオーバー
  - クリア
  - ポーズ中
- ブラックホール発生中
  - 吸い寄せられる
- ブラックホール未発生
  - 慣性移動＋落下
- 無敵時間
  - ミスしてから一定時間
- (保留。動きをみて決定)食べるアニメーション
  - 速度を保存しておいて、アニメ中は移動を停止

## 動作用の変数を決める
状態は、以下の変数で制御できそうです。

- 移動可能かどうかのCanMoveフラグ
- Blackhole.IsSpawnで、ブラックホールの発生状態を確認
- 残りの無敵秒数を入れておくfloat変数`mutekiTime`
- (保留)食べるアニメ中フラグ

これもシンプルなので、状態を管理する変数はなしでよいでしょう。

## アニメーションを決める
ぐらびぃのアニメは以下の種類があります。それぞれの要件をあわせて書き出します。

- Idle 通常時
  - ブラックホールの影響下にない
- Fall 落下
  - ゲームが開始している
  - ブラックホールの影響下にない
  - 地面がない
- Sucked ブラックホールに吸い込まれ
  - ゲームが開始している
  - ブラックホールの影響下にある
- Inhale 食べる
  - 食べるが発動した
- Hungry はらぺこ
  - エネルギーが一定以下の時
- 無敵中(α値を下げる)
  - 無敵時間が0より大きい

以上から、必要なパラメーターを検討します。

- IdleかFallかSuckedは排他的に切り替わるアニメなので、int型のStateパラメーターを作成して、値で制御する
- Inhaleはどの状態からでも発動するもので、アニメによって完了するので、Trigger型のInhaleで制御する
- Hungryは、グラフィックが用意できるのであれば、Idle、Fall、Suckedのそれぞれに対応するものがある。同期した別レイヤーを作成して、スクリプト側からウェイトの変更で切り替える
- 無敵は、他のアニメと同時に発生する可能性がある。別レイヤーで半透明を設定し、Float型のMutekiTimeで制御する

以上で方針が決まったので、アニメーターを作成します。

### Layers
レイヤーを以下のように作成します。

![Graviyのアニメーターのレイヤー](./Images/Graviy00.png)

- Base Layerはデフォルトのまま
- Hungry Layerは以下のように設定します
  - Weightは0
  - Override
  - Syncにチェックをして、Source Layerは*Base Layer*
- Muteki Layerは以下のように設定します
  - Weightは1
  - Override

### Parameters
パラメーターは以下の通りです。

![パラメーター](./Images/Graviy01.png)

- Stateはinteger
- InhaleはTrigger
- MutekiTimeはFloat

### 状態遷移
Base Layerの状態遷移は以下のようにして、上記で検討したようにトランジションを設定しました。Hungry LayerはSyncしているので自動的に同じ状態遷移になります。はらべこアニメが用意できている状態に設定し、ない場合はBaseを同じアニメを設定しておけばよいでしょう。

![Baseレイヤー](./Images/Graviy02.png)

Muteki Layerは以下のようにシンプルです。MutekiTimeが0より大きければMutekiに遷移して、0.001未満なら何もアニメを設定していないNoneに切り替えます。

![Mutekiレイヤー](./Images/Graviy03.png)

以上でアニメは出来上がりです。


# 動きを作る
ぐらびぃを動かすスクリプトを検討します。ぐらびぃは以下のように動きます。

- ゲーム開始まで待機
- 通常は、重力落下をする慣性移動
- ブラックホールの勢力下にあったら、そちらに吸い込まれる
- 画面の左には出ない(スクロールは戻らない)
- 敵にぶつかったらミス
- ライフがなくなるとゲームオーバー
- クリアオブジェクトに触れるとクリア
- アイテムを取ったら食べる
- エネルギーの消費と回復

`Graviy`という名前のC#スクリプトを作成して、Graviyプレハブにアタッチして、そこにコードを書いていきます。ブラックホールで検討したエネルギーのパラメーターもここに実装します。

開発事項が多い場合は、まとめて作ることはせず、１つずつ作っては動作を確認していく方が、バグも少なく、開発もしやすいです。

## 状態の検討


## ゲーム開始まで待機
動作が可能になるまでは、落下はせず、待機アニメのままで静止させておきます。
